{"version":3,"sources":["../src/writeFile.ts"],"sourcesContent":["import { existsSync, mkdirSync } from 'fs'\nimport { resolve } from 'path'\nimport { renderHbsTpl } from '@quick/utils'\nimport { RouteManifest, AddFileOptions, MakePropertyOptional } from './types'\n\nconst __dirname = import.meta.dirname\nconst TML_DIR = resolve(__dirname, 'template')\n\n// 深拷贝\nfunction deepClone<T>(obj: T): T {\n  return JSON.parse(JSON.stringify(obj))\n}\n\n/**创建.quick/index.ts文件 */\nexport function writeIndexts(outDir: string, exports?: AddFileOptions[]) {\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'index.ts.hbs'),\n    outPath: resolve(outDir, 'index.ts'),\n    data: { exports }\n  })\n}\n/**创建.quick/entry.tsx文件 */\nexport function writeEntryTsx(\n  outDir: string,\n  srcDir: string,\n  data: {\n    imports: MakePropertyOptional<AddFileOptions, 'specifier'>[]\n    aheadCodes: string[]\n    tailCodes: string[]\n  }\n) {\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'entry.tsx.hbs'),\n    outPath: resolve(outDir, 'entry.tsx'),\n    data: {\n      ...data,\n      srcDir: resolve(outDir, '..', srcDir)\n    }\n  })\n}\n\n/**写入.quick/types.ts */\nexport function writeTypesTs(\n  outDir: string,\n  pageConfigTypes: AddFileOptions[] = [],\n  appConfigTypes: AddFileOptions[] = []\n) {\n  const all = deepClone([...pageConfigTypes, ...appConfigTypes]).reduce(\n    (acc, item) => {\n      const index = acc.findIndex(v => v.source === item.source)\n      if (\n        index > -1 &&\n        Array.isArray(item.specifier) &&\n        Array.isArray(acc[index].specifier)\n      ) {\n        acc[index].specifier = [...acc[index].specifier, ...item.specifier]\n      } else {\n        acc.push(item)\n      }\n      return acc\n    },\n    [] as AddFileOptions[]\n  )\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'types.ts.hbs'),\n    outPath: resolve(outDir, 'types.ts'),\n    data: { all, pageConfigTypes, appConfigTypes }\n  })\n}\n\n/**写入.quick/define.ts */\nexport function writeDefineTs(outDir: string, srcDir: string) {\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'define.ts.hbs'),\n    outPath: `${outDir}/define.ts`,\n    data: {\n      srcDir: resolve(outDir, '..', srcDir)\n    }\n  })\n}\n\n/**写入.quick/manifest.ts */\nexport function writeRoutesTs(outDir: string, manifest: RouteManifest) {\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'manifest.ts.hbs'),\n    outPath: resolve(outDir, 'manifest.ts'),\n    data: {\n      manifest: Object.values(manifest).sort((a, b) => {\n        const nA = a.id.replace(/\\/?layout/, ''),\n          nB = b.id.replace(/\\/?layout/, '')\n        return nA.length === nB.length\n          ? b.id.indexOf('layout')\n          : nA.length - nB.length\n      })\n    }\n  })\n}\n\n/**写入.quick/runtimes.ts */\nexport function wirteRuntime(outDir: string, runtimes?: string[]) {\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'runtime.ts.hbs'),\n    outPath: resolve(outDir, 'runtime.ts'),\n    data: { runtimes }\n  })\n}\n\n/**写入.quick/typings.d.ts */\nexport function wirteTypings(outDir: string) {\n  renderHbsTpl({\n    sourcePath: resolve(TML_DIR, 'typings.d.ts.hbs'),\n    outPath: resolve(outDir, 'typings.d.ts')\n  })\n}\n\n/**创建临时文件夹 */\nexport function createTmpDir({\n  root,\n  srcDir,\n  options\n}: {\n  root: string\n  srcDir: string\n  options: {\n    manifest?: RouteManifest\n    pageConfigTypes: AddFileOptions[]\n    appConfigTypes: AddFileOptions[]\n    exports: AddFileOptions[]\n    imports: MakePropertyOptional<AddFileOptions, 'specifier'>[]\n    aheadCodes: string[]\n    tailCodes: string[]\n    runtimes: string[]\n  }\n}) {\n  const {\n    manifest = {},\n    pageConfigTypes,\n    appConfigTypes,\n    exports,\n    imports,\n    aheadCodes,\n    tailCodes,\n    runtimes\n  } = options\n  const outDir = resolve(root, '.quick')\n  if (!existsSync(outDir)) {\n    mkdirSync(outDir, { recursive: true })\n  }\n  // 创建.quick/index.ts文件\n  writeIndexts(outDir, exports)\n  // 创建.quick/entry.tsx\n  writeEntryTsx(outDir, srcDir, {\n    imports,\n    aheadCodes,\n    tailCodes\n  })\n  // 创建.quick/types.ts\n  writeTypesTs(outDir, pageConfigTypes, appConfigTypes)\n  // 创建.quick/define.ts\n  writeDefineTs(outDir, srcDir)\n  // 创建.quick/routes.ts\n  writeRoutesTs(outDir, manifest)\n  // 创建.quick/runtime.tsx\n  wirteRuntime(outDir, runtimes)\n  // 创建.quick/typings.d.ts\n  wirteTypings(outDir)\n}\n"],"mappings":"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","names":[]}