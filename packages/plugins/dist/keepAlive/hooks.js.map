{"version":3,"sources":["../../src/keepAlive/hooks.ts"],"sourcesContent":["import { useLayoutEffect, useState, useContext, useRef, useEffect } from 'react'\nimport { ScopeContext } from './context'\nimport { KeepAliveContext } from './context'\n\ntype NoParamsFn = () => void\n\nexport function useGetActivation(name: string){\n  /**\n   * 为了在Active变更时触发组件更新\n   * 不能使用useSyncExternalStore，因为只是Active的属性变更，而不是Active的引用变更，\n   * useSyncExternalStore在获取的值不变时不会触发更新\n   */\n  const [_, setCount] = useState(0)\n  const { getActivation } = useContext(ScopeContext)!\n  useLayoutEffect(() => {\n    const unsubscribe = getActivation(name)!.subscribe(() => {\n      setCount(c => c + 1)\n    })\n    return () => { unsubscribe() }\n  }, [name])\n  return getActivation(name)!\n}\n\n/**获取操作缓存的api */\nexport function useAliveController(){\n  const ctx = useContext(ScopeContext)\n  if(!ctx) return {\n    destroy: () => {},\n    destroyAll: () => {},\n    cachingNodes: []\n  }\n  const { destroy, destroyAll, getCachingNodes } = ctx\n  return { destroy, destroyAll, getCachingNodes }\n}\n\n/**激活时执行的hooks */\nexport function useActivate(fn:NoParamsFn){\n  const at = useContext(KeepAliveContext)\n  if(!at) return\n  useLayoutEffect(() => {\n    const removeListener = at.addActivateHooks(fn)\n    return () => removeListener()\n  }, [fn])\n}\n/**失活时执行的hooks(缓存完全卸载时不触发)\n * 缓存完全卸载时没有办法触发，因为如果卸载时处于失活状态时，没办法触发KeepAlive组件的useEffect\n */\nexport function useUnactivate(fn:NoParamsFn){\n  const at = useContext(KeepAliveContext)\n  if(!at) return\n  useLayoutEffect(() => {\n    const removeListener = at.addUnactivateHooks(fn)\n    return () => removeListener()\n  }, [fn])\n}\n\nexport function useLoadedEffect(fn:NoParamsFn, deps:any[]){\n  const loaded = useRef(false)\n  useEffect(() => {\n    if(loaded.current) {\n      return fn()\n    }else {\n      loaded.current = true\n    }\n  }, deps)\n}\n\nexport function useLoadedLayoutEffect(fn:NoParamsFn, deps:any[]){\n  const loaded = useRef(false)\n  useLayoutEffect(() => {\n    if(loaded.current) {\n      return fn()\n    }else {\n      loaded.current = true\n    }\n  }, deps)\n}"],"mappings":";;;;;;AAAA,SAAS,iBAAiB,UAAU,YAAY,QAAQ,iBAAiB;AAMlE,SAAS,iBAAiB,MAAa;AAM5C,QAAM,CAAC,GAAG,QAAQ,IAAI,SAAS,CAAC;AAChC,QAAM,EAAE,cAAc,IAAI,WAAW,YAAY;AACjD,kBAAgB,MAAM;AACpB,UAAM,cAAc,cAAc,IAAI,EAAG,UAAU,MAAM;AACvD,eAAS,OAAK,IAAI,CAAC;AAAA,IACrB,CAAC;AACD,WAAO,MAAM;AAAE,kBAAY;AAAA,IAAE;AAAA,EAC/B,GAAG,CAAC,IAAI,CAAC;AACT,SAAO,cAAc,IAAI;AAC3B;AAGO,SAAS,qBAAoB;AAClC,QAAM,MAAM,WAAW,YAAY;AACnC,MAAG,CAAC,IAAK,QAAO;AAAA,IACd,SAAS,MAAM;AAAA,IAAC;AAAA,IAChB,YAAY,MAAM;AAAA,IAAC;AAAA,IACnB,cAAc,CAAC;AAAA,EACjB;AACA,QAAM,EAAE,SAAS,YAAY,gBAAgB,IAAI;AACjD,SAAO,EAAE,SAAS,YAAY,gBAAgB;AAChD;AAGO,SAAS,YAAY,IAAc;AACxC,QAAM,KAAK,WAAW,gBAAgB;AACtC,MAAG,CAAC,GAAI;AACR,kBAAgB,MAAM;AACpB,UAAM,iBAAiB,GAAG,iBAAiB,EAAE;AAC7C,WAAO,MAAM,eAAe;AAAA,EAC9B,GAAG,CAAC,EAAE,CAAC;AACT;AAIO,SAAS,cAAc,IAAc;AAC1C,QAAM,KAAK,WAAW,gBAAgB;AACtC,MAAG,CAAC,GAAI;AACR,kBAAgB,MAAM;AACpB,UAAM,iBAAiB,GAAG,mBAAmB,EAAE;AAC/C,WAAO,MAAM,eAAe;AAAA,EAC9B,GAAG,CAAC,EAAE,CAAC;AACT;AAEO,SAAS,gBAAgB,IAAe,MAAW;AACxD,QAAM,SAAS,OAAO,KAAK;AAC3B,YAAU,MAAM;AACd,QAAG,OAAO,SAAS;AACjB,aAAO,GAAG;AAAA,IACZ,OAAM;AACJ,aAAO,UAAU;AAAA,IACnB;AAAA,EACF,GAAG,IAAI;AACT;AAEO,SAAS,sBAAsB,IAAe,MAAW;AAC9D,QAAM,SAAS,OAAO,KAAK;AAC3B,kBAAgB,MAAM;AACpB,QAAG,OAAO,SAAS;AACjB,aAAO,GAAG;AAAA,IACZ,OAAM;AACJ,aAAO,UAAU;AAAA,IACnB;AAAA,EACF,GAAG,IAAI;AACT;","names":[]}