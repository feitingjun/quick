{"version":3,"sources":["../src/method.ts"],"sourcesContent":["import { createRoot } from 'react-dom/client'\nimport {\n  createElement,\n  StrictMode,\n  ReactNode,\n  createContext,\n  useContext\n} from 'react'\nimport {\n  RouteObject,\n  useLoaderData as useRouteLoaderData,\n  createBrowserRouter,\n  createHashRouter,\n  createMemoryRouter,\n  LoaderFunction,\n  RouterProvider\n} from 'react-router'\nimport {\n  AppContextType,\n  PageConfig,\n  DataLoadeContext,\n  UseLoaderDataReturn,\n  DataLoader,\n  ManifestClient,\n  AppConfig\n} from './types'\nimport {\n  RouteManifest,\n  RouteManifestObject,\n  Wrapper,\n  Provider,\n  Runtime,\n  RuntimeOptions\n} from '@quick/core'\n\nconst AppContext = createContext<AppContextType<any>>({\n  manifest: {},\n  routes: [],\n  appData: {}\n})\n\nexport const useAppContext = <T extends Record<string, unknown>>() => {\n  return useContext<AppContextType<T>>(AppContext)\n}\n\nexport const useConfig = <T>() => {\n  return useRouteLoaderData<UseLoaderDataReturn<unknown, T>>().config\n}\n\nexport const useLoaderData = <T = unknown>() => {\n  return useRouteLoaderData<UseLoaderDataReturn<T, unknown>>().data\n}\n\nconst loader = (module: {\n  loader?: DataLoader\n  config?: PageConfig\n}): LoaderFunction => {\n  const { loader: dataLoader, config: pageConfig = {} } = module\n  return async ({ request }) => {\n    const { pathname, search, searchParams } = new URL(request.url)\n    const ctx: DataLoadeContext = {\n      pathname,\n      search,\n      query: Object.fromEntries(searchParams.entries())\n    }\n    const data =\n      dataLoader && typeof dataLoader === 'function'\n        ? await dataLoader({ ctx })\n        : dataLoader\n    return {\n      data: data,\n      config:\n        typeof pageConfig === 'function'\n          ? await pageConfig({\n              ctx,\n              data\n            })\n          : pageConfig\n    }\n  }\n}\n\nconst generateRoutes = (\n  manifest: ManifestClient,\n  wrappers: Wrapper[],\n  parentId?: string\n): RouteObject[] => {\n  return Object.values(manifest)\n    .filter(v => v.parentId == parentId)\n    .map(v => {\n      return {\n        id: v.id,\n        path: v.path,\n        pathname: v.pathname,\n        parendId: v.parentId,\n        layout: v.layout,\n        HydrateFallback: () => createElement('div', null, 'loading...'),\n        async lazy() {\n          const module = await v.component()\n          return {\n            loader: loader(module),\n            Component: () =>\n              wrappers.reduce((acc, fn) => {\n                return createElement(\n                  fn,\n                  {\n                    routeId: v.id,\n                    layout: v.layout,\n                    path: v.path,\n                    pathname: v.pathname,\n                    parentId: v.parentId\n                  },\n                  acc\n                )\n              }, createElement(module.default, null))\n          }\n        },\n        children: generateRoutes(manifest, wrappers, v.id)\n      }\n    })\n}\n\n/**根据路由清单递归生成路由 */\nconst generateRoutesByManifest = (\n  manifest: RouteManifest,\n  parentId?: string\n): (RouteManifestObject & { children?: RouteManifestObject[] })[] => {\n  return Object.values(manifest)\n    .filter(v => v.parentId == parentId)\n    .map(v => {\n      const children = generateRoutesByManifest(manifest, v.id)\n      return {\n        ...v,\n        children\n      }\n    })\n}\n\nexport const createApp = ({\n  manifest,\n  app: appConfig,\n  runtimes\n}: {\n  manifest: ManifestClient\n  app: AppConfig\n  runtimes: Runtime[]\n}) => {\n  const {\n    root = 'app',\n    strict,\n    router: mode,\n    patchManifest,\n    patchRoutes,\n    appData,\n    rootContainer\n  } = appConfig ?? {}\n  // 处理插件运行时\n  const providers: Provider[] = []\n  const wrappers: Wrapper[] = []\n  const addProvider: RuntimeOptions['addProvider'] = fn => {\n    providers.push(fn)\n  }\n  const addWrapper: RuntimeOptions['addWrapper'] = fn => {\n    wrappers.push(fn)\n  }\n  runtimes?.forEach(runtime => {\n    runtime({\n      appContext: {\n        manifest,\n        appConfig\n      },\n      addProvider,\n      addWrapper\n    })\n  })\n\n  let createRouter = createBrowserRouter\n  if (mode === 'hash') {\n    createRouter = createHashRouter\n  }\n  if (mode === 'memory') {\n    createRouter = createMemoryRouter\n  }\n  if (patchManifest && typeof patchManifest === 'function') {\n    manifest = patchManifest(manifest)\n  }\n  let routes = generateRoutes(manifest, wrappers)\n  if (patchRoutes && typeof patchRoutes === 'function') {\n    routes = patchRoutes(routes)\n  }\n  // 创建router\n  const router = createRouter(routes, { basename: '/' })\n  // 创建RouterProvider\n  let app: ReactNode = createElement(RouterProvider, { router })\n\n  // 向RouterProvider外层添加插件中的Provider\n  app = providers.reduce((acc, fn) => {\n    return createElement(fn, null, acc)\n  }, app)\n\n  // 向RouterProvider外层添加AppContextProvider\n  app = createElement(\n    AppContext.Provider,\n    {\n      value: {\n        manifest,\n        routes,\n        appData\n      }\n    },\n    app\n  )\n\n  if (rootContainer && typeof rootContainer === 'function') {\n    app = rootContainer(app)\n  }\n  if (strict) {\n    app = createElement(StrictMode, null, app)\n  }\n\n  let rootEle = document.getElementById(root)\n  if (!rootEle) {\n    rootEle = document.createElement('div')\n    rootEle.id = root\n    document.body.appendChild(rootEle)\n  }\n  createRoot(rootEle).render(app)\n}\n"],"mappings":"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","names":[]}